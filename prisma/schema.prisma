generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String
  fullName        String?
  phoneNumber     String?
  faculty         String?
  department      String?
  academicLevel   String?
  residenceArea   String?
  isVerified      Boolean  @default(false)
  verificationLevel VerificationLevel @default(BASIC)
  verificationStatus VerificationStatus @default(NOT_VERIFIED)
  badge           String?
  avatarUrl       String?
  idDocumentUrl   String?
  isAdmin         Boolean  @default(false)
  role            UserRole @default(USER)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  wallet          Wallet?
  listings        Listing[]
  reviewsReceived Review[] @relation("ReceivedReviews")
  reviewsGiven    Review[] @relation("GivenReviews")
  verifications   Verification[]
  conversationsAsBuyer Conversation[] @relation("BuyerConversations")
  messages        Message[]
  savedItems      SavedItem[]
  notifications   Notification[]
  preference      Preference?
  reportsMade     Report[]    @relation("ReportsMade")
  reportsReceived Report[]    @relation("ReportsReceived")

  // Advanced Admin Fields
  lastLoginAt     DateTime?
  lastLoginIp     String?
  trustScore      Float       @default(50.0)
  riskScore       Float       @default(0.0)
  devices         UserDevice[]
  adminLogs       AdminLog[]  // Logs about this user
  performedActions AdminLog[] @relation("Actor")
  assignedModerations ListingModeration[] @relation("AssignedModerator")
  moderationLogs  ModerationLog[]

  // Smart Contracts
  buyerContracts   SmartContract[] @relation("ContractBuyer")
  sellerContracts  SmartContract[] @relation("ContractSeller")
  contractAudits   ContractAudit[]
  contractEvidence ContractEvidence[]

  // Referrals
  referredBy       User?   @relation("UserReferrals", fields: [referredById], references: [id])
  referredById     String?
  referrals        User[]  @relation("UserReferrals")

  // Growth Analytics
  marketOffers     MarketOffer[]
  npsSurveys       NPSSurvey[]
  bulkOperations   BulkOperation[]
}

model Wallet {
  id           String        @id @default(uuid())
  userId       String        @unique
  user         User          @relation(fields: [userId], references: [id])
  balance         Decimal       @default(0) @db.Decimal(12, 2)
  reservedBalance Decimal       @default(0) @db.Decimal(12, 2)
  transactionPin  String?
  pinSetAt        DateTime?
  transactions    Transaction[]
  withdrawals     Withdrawal[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Transaction {
  id          String          @id @default(uuid())
  walletId    String
  wallet      Wallet          @relation(fields: [walletId], references: [id])
  amount      Decimal         @db.Decimal(12, 2)
  type        TransactionType
  status      String          @default("PENDING") // PENDING, SUCCESS, FAILED
  reference   String?          @unique
  description String?
  
  platformFee Decimal         @default(0) @db.Decimal(12, 2)

  // Escrow Fields
  listingId         String?
  listing           Listing?        @relation(fields: [listingId], references: [id])
  escrowStatus      EscrowStatus    @default(PENDING)
  escrowReleaseDate DateTime?
  disputeLikelihood Float           @default(0.0)
  metadata          Json?           // For flexible risk flags/details

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  smartContract SmartContract?
}

enum TransactionType {
  DEPOSIT
  PURCHASE
  SALE
  WITHDRAWAL
  ESCROW_HOLD
}

model Listing {
  id          String        @id @default(uuid())
  sellerId    String
  seller      User          @relation(fields: [sellerId], references: [id])
  title       String
  description String
  price       Decimal       @db.Decimal(12, 2)
  category    String
  condition   ItemCondition
  status      ListingStatus @default(ACTIVE)
  faculty     String?
  department  String?
  images      ListingImage[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  conversations Conversation[]
  savedBy       SavedItem[]
  analytics     ListingAnalytics?
  reports       Report[]
  moderation      ListingModeration?
  moderationLogs  ModerationLog[]
  transactions    Transaction[]
  smartContracts  SmartContract[]
  marketOffers    MarketOffer[]
}

enum EscrowStatus {
  PENDING
  HELD
  RELEASE_SCHEDULED
  RELEASED
  DISPUTED
  REFUNDED
}

model ListingImage {
  id        String  @id @default(uuid())
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])
  url       String
  isPrimary Boolean @default(false)
}

enum ListingStatus {
  DRAFT
  ACTIVE
  RESERVED
  SOLD
  ARCHIVED
}

enum ItemCondition {
  NEW
  USED
  FAIR
}

model Review {
  id         String   @id @default(uuid())
  targetId   String
  target     User     @relation("ReceivedReviews", fields: [targetId], references: [id])
  reviewerId String
  reviewer   User     @relation("GivenReviews", fields: [reviewerId], references: [id])
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
}

model Verification {
  id              String             @id @default(uuid())
  userId          String
  user            User               @relation(fields: [userId], references: [id])
  documentType    String
  documentFrontUrl String
  documentBackUrl  String?
  status          VerificationStatus @default(PENDING)
  adminNotes      String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

enum VerificationLevel {
  BASIC
  VERIFIED
  PREMIUM_VERIFIED
}

enum VerificationStatus {
  NOT_VERIFIED
  PENDING
  APPROVED
  REJECTED
}

model Conversation {
  id        String    @id @default(uuid())
  listingId String
  listing   Listing   @relation(fields: [listingId], references: [id])
  buyerId   String
  buyer     User      @relation("BuyerConversations", fields: [buyerId], references: [id])
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([listingId, buyerId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
}

model SavedItem {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
}

enum NotificationType {
  MESSAGE
  TRANSACTION
  SYSTEM
  PRICE_ALERT
}

model Preference {
  id                  String    @id @default(uuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id])
  themeMode           ThemeMode @default(AUTO)
  facultyThemeEnabled Boolean   @default(true)
  accentColor         String?
  primaryColor        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

enum ThemeMode {
  LIGHT
  DARK
  AUTO
}

model Withdrawal {
  id              String           @id @default(uuid())
  walletId        String
  wallet          Wallet           @relation(fields: [walletId], references: [id])
  amount          Decimal          @db.Decimal(12, 2)
  bankCode        String
  accountNumber   String
  accountName     String
  fee             Decimal          @db.Decimal(12, 2)
  netAmount       Decimal          @db.Decimal(12, 2)
  status          WithdrawalStatus @default(PENDING)
  reference       String?
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model ListingAnalytics {
  id              String   @id @default(uuid())
  listingId       String   @unique
  listing         Listing  @relation(fields: [listingId], references: [id])
  totalViews      Int      @default(0)
  searchViews     Int      @default(0)
  facultyViews    Int      @default(0)
  directViews     Int      @default(0)
  saves           Int      @default(0)
  messages        Int      @default(0)
  lastViewedAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Report {
  id              String       @id @default(uuid())
  reporterId      String
  reporter        User         @relation("ReportsMade", fields: [reporterId], references: [id])
  reportedUserId  String?
  reportedUser    User?        @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  reportedListingId String?
  reportedListing Listing?     @relation(fields: [reportedListingId], references: [id])
  reason          ReportReason
  description     String
  evidenceUrls    String[]
  status          ReportStatus @default(UNDER_REVIEW)
  priority        ReportPriority @default(MEDIUM)
  reviewedBy      String?
  reviewedAt      DateTime?
  resolution      String?
  createdAt       DateTime     @default(now())
}

enum ReportReason {
  PROHIBITED_ITEM
  MISLEADING
  SCAM
  HARASSMENT
  INAPPROPRIATE_BEHAVIOR
}

enum ReportStatus {
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model UserDevice {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  userAgent   String?
  ipAddress   String
  fingerprint String?
  lastActive  DateTime @default(now())
}

model AdminLog {
  id          String   @id @default(uuid())
  action      String
  actorId     String
  actor       User     @relation("Actor", fields: [actorId], references: [id])
  targetId    String?
  target      User?    @relation(fields: [targetId], references: [id])
  details     Json?    // Specific changes or filters used
  ipAddress   String?
  createdAt   DateTime @default(now())
}

model ListingModeration {
  id            String    @id @default(uuid())
  listingId     String    @unique
  listing       Listing   @relation(fields: [listingId], references: [id])
  priorityScore Float     @default(0.0)
  status        ModerationStatus @default(PENDING)
  flaggedBy     String[]  // "AI", "USER_REPORT", "PRICE_ANOMALY"
  autoFlagReason String?
  assignedToId  String?
  assignedTo    User?     @relation("AssignedModerator", fields: [assignedToId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model ModerationLog {
  id          String   @id @default(uuid())
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id])
  moderatorId String
  moderator   User     @relation(fields: [moderatorId], references: [id])
  action      ModerationAction
  reason      String?
  notes       String?
  createdAt   DateTime @default(now())
}

enum ModerationStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum ModerationAction {
  APPROVE
  REJECT
  FLAG
  REQUEST_CHANGES
}

model SmartContract {
  id          String           @id @default(uuid())
  buyerId     String
  buyer       User             @relation("ContractBuyer", fields: [buyerId], references: [id])
  sellerId    String
  seller      User             @relation("ContractSeller", fields: [sellerId], references: [id])
  listingId   String
  listing     Listing          @relation(fields: [listingId], references: [id])
  transactionId String?        @unique
  transaction Transaction?     @relation(fields: [transactionId], references: [id])
  
  terms       Json             // Price, escrowFee, releaseConditions, disputeResolution
  state       Json             // Current variable state: { buyer_signed: boolean, seller_signed: boolean, locked_funds: boolean }
  status      SmartContractStatus @default(CREATED)
  version     Int              @default(1)
  
  audits      ContractAudit[]
  evidence    ContractEvidence[]
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

enum SmartContractStatus {
  CREATED
  SIGNED
  FUNDED
  ACTIVE
  COMPLETED
  DISPUTED
  CANCELLED
}

model ContractAudit {
  id          String   @id @default(uuid())
  contractId  String
  contract    SmartContract @relation(fields: [contractId], references: [id])
  action      String   // CREATED, SIGNED, RELEASE_REQUESTED
  actorId     String
  actor       User     @relation(fields: [actorId], references: [id])
  payload     Json?
  hash        String   // Cryptographic hash for immutability check
  timestamp   DateTime @default(now())
}

model ContractEvidence {
  id          String   @id @default(uuid())
  contractId  String
  contract    SmartContract @relation(fields: [contractId], references: [id])
  uploaderId  String
  uploader    User     @relation(fields: [uploaderId], references: [id])
  type        EvidenceType
  url         String
  metadata    Json?
  createdAt   DateTime @default(now())
}

enum EvidenceType {
  PHOTO
  DOCUMENT
  GPS
  DELIVERY_PROOF
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  userId    String?
  sessionId String?
  eventType String   // VISIT, SIGNUP_START, VIEW_LISTING, PURCHASE, etc.
  metadata  Json?
  createdAt DateTime @default(now())
}

model MarketOffer {
  id        String          @id @default(uuid())
  listingId String
  listing   Listing         @relation(fields: [listingId], references: [id])
  bidderId  String
  bidder    User            @relation(fields: [bidderId], references: [id])
  amount    Decimal         @db.Decimal(12, 2)
  status    OfferStatus     @default(PENDING)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model NPSSurvey {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  score     Int      // 0-10
  feedback  String?
  createdAt DateTime @default(now())
}

model BulkOperation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // BULK_CREATE, BULK_RENEW, PRICE_OPTIMIZE, BULK_MESSAGE, EXPORT
  status    String   // PENDING, PROCESSING, COMPLETED, FAILED
  metadata  Json?    // Stores filters, template IDs, etc.
  result    Json?    // Stores success counts, download URLs
  errors    Json?    // Stores row-level errors
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
